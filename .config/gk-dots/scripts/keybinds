#!/usr/bin/env bash
set -euo pipefail

############################
# CONFIG
############################
KEYBIND_FILE="$HOME/.config/hypr/keybindings/keybinds.conf"
WOFI_CMD="wofi --dmenu --prompt 'Hyprland Keybindings' --width 700 --height 500"
CLIP_CMD="wl-copy"

############################
# SANITY CHECKS
############################
[[ -f "$KEYBIND_FILE" ]] || {
  echo "ERROR: Keybindings file not found: $KEYBIND_FILE" >&2
  exit 1
}

command -v wofi >/dev/null || {
  echo "ERROR: wofi is not installed" >&2
  exit 1
}

command -v wl-copy >/dev/null || {
  echo "ERROR: wl-copy not found (install wl-clipboard)" >&2
  exit 1
}

############################
# PARSER
############################
parse_keybinds() {
  awk '
    /^[[:space:]]*#/ || /^[[:space:]]*$/ { next }

    /^[[:space:]]*bind/ {
      split($0, eq, "=")
      if (length(eq) < 2) next

      gsub(/^[[:space:]]+|[[:space:]]+$/, "", eq[2])
      n = split(eq[2], parts, ",")

      if (n < 3) next

      mod = parts[1]
      key = parts[2]
      action = parts[3]

      gsub(/^[[:space:]]+|[[:space:]]+$/, "", mod)
      gsub(/^[[:space:]]+|[[:space:]]+$/, "", key)
      gsub(/^[[:space:]]+|[[:space:]]+$/, "", action)

      args = ""
      for (i = 4; i <= n; i++) {
        gsub(/^[[:space:]]+|[[:space:]]+$/, "", parts[i])
        args = args " " parts[i]
      }

      combo = mod "+" key
      desc  = action (args ? ":" args : "")

      printf "%-28s â†’ %s\n", combo, desc
    }
  ' "$KEYBIND_FILE" | sort -u
}

############################
# MAIN
############################
selection="$(parse_keybinds | eval "$WOFI_CMD")"

[[ -z "${selection:-}" ]] && exit 0

printf "%s" "$selection" | "$CLIP_CMD"
